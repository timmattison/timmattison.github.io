
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tim Mattison</title>
  <meta name="author" content="Tim Mattison">

  
  <meta name="description" content="I was working on a few applications that involve servlets recently and I came across a situation that initially seemed challenging to test with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.timmattison.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tim Mattison" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<script type="text/javascript">
/* <![CDATA[ */
    (function() {
        var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
        t.parentNode.insertBefore(s, t);
    })();
/* ]]> */
</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46746763-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tim Mattison</a></h1>
  
    <h2>Hardcore tech</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.timmattison.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/12/16/mockito-and-servletinputstreams/">Mockito and ServletInputStreams</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-16T07:00:22-05:00" pubdate data-updated="true">Dec 16<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/12/16/mockito-and-servletinputstreams/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/12/16/mockito-and-servletinputstreams/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was working on a few applications that involve servlets recently and I came across a situation that initially seemed challenging to test with <a href="https://github.com/mockito/mockito">Mockito</a>.  I wanted to do something relatively simple which was read a <a href="https://github.com/google/protobuf/">Protobuf</a> sent from a client, turn it into an object, and do some processing on it.</p>

<p>The question is how do you test a servlet that needs to get the input stream from a servlet request?</p>

<p>I found <a href="https://stackoverflow.com/questions/13353545/mocking-multipart-mime-request-with-mockito">a Stack Overflow post that addresses how to do this with an older version of the ServletInputStream</a> but doing it now requires that you override three additional methods (<code>isFinished</code>, <code>isReady</code>, and <code>setReadListener</code>).</p>

<p>My issue with this is that I don&rsquo;t want to override those methods because I don&rsquo;t really know what I want them to do.  If I&rsquo;m mocking something I want to make sure I know when and where it will be used or I want the mocking framework to return default values or throw exceptions so I know where to look when something breaks.</p>

<p>What I landed on was using the <code>thenAnswer</code> method like this:</p>

<p>&#8220;` java Mocking a ServletInputStream</p>

<pre><code>    byte[] myBinaryData = "TEST".getBytes();
    ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(myBinaryData);

    mockServletInputStream = mock(ServletInputStream.class);

    when(mockServletInputStream.read(Matchers.&lt;byte[]&gt;any(), anyInt(), anyInt())).thenAnswer(new Answer&lt;Integer&gt;() {
        @Override
        public Integer answer(InvocationOnMock invocationOnMock) throws Throwable {
            Object[] args = invocationOnMock.getArguments();
            byte[] output = (byte[]) args[0];
            int offset = (int) args[1];
            int length = (int) args[2];
            return byteArrayInputStream.read(output, offset, length);
        }
    });
</code></pre>

<p> &#8220;`</p>

<p> If you need to ever mock a ServletInputStream feel free to use this code to do it.  So far it has worked perfectly for me.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/">Fixing Javac on Mac OS When Multiple JVMs Are Installed</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-12T06:59:45-05:00" pubdate data-updated="true">Nov 12<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For some reason I decided to install the Java 8 JDK a few days ago when I upgraded to Yosemite.  In IntelliJ it isn&rsquo;t a problem but on the command-line it isn&rsquo;t so nice.  Here&rsquo;s what I get when I try to use javac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> javac src/com/timmattison/Main.java
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/Object.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/String.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/Object.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;: class file for jdk.Profile+Annotation not found</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/String.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/AutoCloseable.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/AutoCloseable.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/System.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/System.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/PrintStream.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/PrintStream.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/FilterOutputStream.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/FilterOutputStream.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/OutputStream.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I run <code>javac -version</code> I get mostly what I&rsquo;d expect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> javac -version
</span><span class='line'><span class="go">javac 1.7.0_45</span>
</span></code></pre></td></tr></table></div></figure>


<p>So why is it trying to use libraries from the Java 8 JDK?  Simply because I forgot to set JAVA_HOME.  On Mac OS you can quickly fix this by adding the following line to your .bash_profile and starting a new Terminal session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">export JAVA_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk1.7.0_45.jdk/Contents/Home/&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course you should change <code>_45</code> to reflect the specific version you&rsquo;re running and validate that the path in the <code>JAVA_HOME</code> variable exists.</p>

<p>Good luck!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/11/12/when-unicode-goes-wrong-in-java/">When Unicode Goes Wrong in Java</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-12T06:50:31-05:00" pubdate data-updated="true">Nov 12<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/11/12/when-unicode-goes-wrong-in-java/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/11/12/when-unicode-goes-wrong-in-java/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>NOTE: This is only guaranteed to work with the Sun JVM since this option is <a href="https://stackoverflow.com/questions/2168350/java-charset-problem-on-linux?answertab=votes#tab-top">&ldquo;an internal detail of Sun&rsquo;s implementations&rdquo;</a>.</p>

<p>UPDATE 2014-11-12 6:22 PM: The real fix is to set the environment variable LANG to <code>en_US.UTF-8</code> right before you start your JVM.</p>

<p>Is Unicode breaking in your application and you can&rsquo;t figure out where?  Maybe data from HttpClient is coming back mangled, maybe database queries via JDBC are having Unicode data replaced with question marks, maybe your <a href="https://code.google.com/p/protobuf/">protobufs</a> are getting shredded, but somewhere something is eating your Unicode data and nothing you&rsquo;ve tried fixes it.  Well&hellip;</p>

<p>Did you know the JVM itself has a global Unicode setting specified by the <code>-Dfile.encoding</code> option?  Most people I talked to didn&rsquo;t know about it, myself included, when I ran into a Unicode issue on a project.  After some great teamwork and research we found this option, set it, and everything started working again.</p>

<p>All we had to do was put <code>-Dfile.encoding=UTF8</code> in the script that ran our JVM and everything was fixed but that was only a temporary fix.  You really need to set LANG to <code>en_US.UTF-8</code>.  If you want to play with it <a href="https://github.com/timmattison/jvm-unicode-settings">I created a test project on Github</a> that is incredibly simple and shows the right and wrong settings and what they do to a simple trademark symbol.  Otherwise, try this on your project and see if it fixes the issue.</p>

<p>Good luck!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/">Using Interfaces in Camel&#8217;s Java DSL With Spring</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-30T16:29:26-04:00" pubdate data-updated="true">Oct 30<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When writing some routes with Camel&rsquo;s Java DSL I came across this exception:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Caused by: java.lang.IllegalStateException: No method invocation could be created, no matching method could be found on: null</span></code></pre></td></tr></table></div></figure>


<p>After a lot of tracing I figured out that it was related to me calling the <code>.bean(...)</code> method with a class that was actually just an interface.  What was happening was that Camel wants to instantiate this class, usually using Spring, but cannot do that if it isn&rsquo;t a concrete implementation.</p>

<p>This proved to be a real problem because I had an interface that had two implementations.  One of these implementations is used for debugging and the other is used for production.  I didn&rsquo;t want to have to manually select which one I was using in my code because that&rsquo;s Spring&rsquo;s job so I came up with a way to do it.</p>

<p>For the complete background here&rsquo;s what my interface looks like:</p>

<figure class='code'><figcaption><span>The interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.Processor</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProtobufToWire</span> <span class="kd">extends</span> <span class="n">Processor</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This converts a Protobuf to our &ldquo;wire&rdquo; format.  That format could be the native protobuf binary format or JSON.  I implement this empty interface in two classes called <code>ProtobufToBinary</code> and <code>ProtobufToJson</code> and I want to use the JSON one only for debugging.</p>

<p>To be clear doing this always fails with the exception I listed above:</p>

<figure class='code'><figcaption><span>A route that always fails</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">from</span><span class="o">(</span><span class="n">SOME_URI</span><span class="o">).</span><span class="na">bean</span><span class="o">(</span><span class="n">ProtobufToWire</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>To fix this I added this to my Java-based Spring config:</p>

<figure class='code'><figcaption><span>Getting an instance of ProtobufToWire</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Bean</span>
</span><span class='line'><span class="kd">public</span> <span class="n">ProtobufToWire</span> <span class="nf">protobufToWire</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">ProtobufToBinary</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now because, I believe, that Camel&rsquo;s <code>bean(...)</code> method doesn&rsquo;t look up the beans with Spring this still fails.  What I needed to where I am defining my routes is this:</p>

<figure class='code'><figcaption><span>Finally, how to get Camel to instantiate the right type</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@Autowired</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ProtobufToWire</span> <span class="n">protobufToWire</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">from</span><span class="o">(</span><span class="n">SOME_URI</span><span class="o">).</span><span class="na">bean</span><span class="o">(</span><span class="n">protobufToWire</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What I&rsquo;m doing here is getting Spring to autowire an instance of that interface into a private variable and then asking it for its real concrete type.  Part of me says that I shouldn&rsquo;t have to do this but this is what works for me.</p>

<p>Did this help you out?  Do you have a better way to do it?  Post in the comments!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/">Activating U2F on a Yubikey Neo on Mac OS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-28T16:25:12-04:00" pubdate data-updated="true">Oct 28<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just got my Yubikey Neo with U2F support and I felt like the documentation on how to get it up and running was a bit hard to find.  If you are having trouble getting started with U2F these few quick steps will help you get through it.</p>

<p>Step 0: Download and install the <a href="https://developers.yubico.com/yubikey-neo-manager/Releases/">Yubikey Neo Manager application</a>.  This is NOT the Yubikey Personalization Tool!  The Yubikey Personalization Tool does not support enabling U2F yet.</p>

<p>Step 1: Open the Yubikey Neo Manager with your Yubikey installed and click <code>Change connection mode [OTP]</code> <img src="/images/yubikey-neo-manager/step-1.png" alt="Yubikey Neo Manager main screen" /></p>

<p>Step 2: On the <code>Change connection mode</code> check the <code>U2F</code> box to change the setting from <code>OTP</code> to <code>U2F</code> and click <code>OK</code>. <img src="/images/yubikey-neo-manager/step-2.png" alt="Yubikey Neo Manager main screen" /> <img src="/images/yubikey-neo-manager/step-3.png" alt="Yubikey Neo Manager main screen" /></p>

<p>The application will now prompt you to remove your device.  You can remove it and plug it back in again.  Close the Yubikey Neo Manager application.</p>

<p>Step 3: Open Chrome and install the <a href="https://chrome.google.com/webstore/detail/fido-u2f-universal-2nd-fa/pfboblefjcgdjicmnffhdgionmgcdmne">FIDO U2F (Universal 2nd Factor) extension</a> from the Chrome web store.</p>

<p>Step 4: Register on <a href="http://demo.yubico.com/u2f">Yubico&rsquo;s U2F demo page</a> and you&rsquo;re done.</p>

<p>Now you can log in on the demo page and other sites that support U2F.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/10/27/building-apache-camel-applications-with-guice/">Building Apache Camel Applications With Guice</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-27T18:40:13-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/10/27/building-apache-camel-applications-with-guice/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/10/27/building-apache-camel-applications-with-guice/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://camel.apache.org/">Apache Camel</a> is a great framework for implementing <a href="https://camel.apache.org/enterprise-integration-patterns.html">Enterprise Integration Patterns</a>.  However, most of the examples you&rsquo;ll find out there show you how to use it with <a href="http://projects.spring.io/spring-framework/">the Spring framework</a>.  I&rsquo;m much more comfortable with <a href="https://github.com/google/guice">Google Guice</a> since I&rsquo;ve used it in more production projects.</p>

<p>I did find an example of how to use Guice with Apache Camel but it wasn&rsquo;t commented well and involved doing a lot of extra work that didn&rsquo;t provide me any benefits.  So below I&rsquo;ve listed the things that you&rsquo;ll need to do to get Guice and Camel working together.  What we are doing here is setting up Guice as a JNDI provider and automatically loading a Guice CamelModule via JNDI.</p>

<p>Step 1: Create a <code>jndi.properties</code> file in your project&rsquo;s <code>resources</code> directory.  The <code>java.naming.factory.initial</code> line tells JNDI to use Guice, the <code>org.guiceyfruit.modules</code> tells the <a href="http://docs.oracle.com/javase/7/docs/api/javax/naming/InitialContext.html">javax.naming.InitialContext class</a> which module it should run at startup.</p>

<figure class='code'><figcaption><span>jndi.properties</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="c"># Guice JNDI provider</span>
</span><span class='line'><span class="na">java.naming.factory.initial</span> <span class="o">=</span> <span class="s">org.apache.camel.guice.jndi.GuiceInitialContextFactory</span>
</span><span class='line'>
</span><span class='line'><span class="c"># list of guice modules to boot up (space separated)</span>
</span><span class='line'><span class="na">org.guiceyfruit.modules</span> <span class="o">=</span> <span class="s">com.timmattison.CamelGuiceApplicationModule</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 2: Create a class with a static main method that will run your Camel routes.  Because JNDI and Guice do most of the work there isn&rsquo;t much to do here.</p>

<figure class='code'><figcaption><span>com.timmattison.CamelApplication</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.naming.InitialContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelApplication</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Create the Camel context with Guice</span>
</span><span class='line'>        <span class="n">InitialContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Loop forever</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Sleep so we don&#39;t kill the CPU</span>
</span><span class='line'>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Create a class that extends <code>RouteBuilder</code> that implements a route (or multiple routes).</p>

<p>In my case I created a RestRoutes class that used the <a href="http://restlet.com/">RESTlet framework</a> and created a single route using the <a href="https://camel.apache.org/direct.html">Direct component</a>.</p>

<p>I moved the constants out to separate classes so they&rsquo;d be easier to refer to in other places if necessary.</p>

<figure class='code'><figcaption><span>com.timmattison.CamelConstants</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelConstants</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DIRECT_TEST_ROUTE_1</span> <span class="o">=</span> <span class="s">&quot;direct:testRoute1&quot;</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.HttpConstants</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpConstants</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEST_URL_1</span> <span class="o">=</span> <span class="s">&quot;/test1&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEST_URL_2</span> <span class="o">=</span> <span class="s">&quot;/test2&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEST_URL_3</span> <span class="o">=</span> <span class="s">&quot;/test3&quot;</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.RestRoutes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.builder.RouteBuilder</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.model.rest.RestBindingMode</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestRoutes</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">RESTLET</span> <span class="o">=</span> <span class="s">&quot;restlet&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">restConfiguration</span><span class="o">().</span><span class="na">bindingMode</span><span class="o">(</span><span class="n">RestBindingMode</span><span class="o">.</span><span class="na">auto</span><span class="o">).</span><span class="na">component</span><span class="o">(</span><span class="n">RESTLET</span><span class="o">).</span><span class="na">port</span><span class="o">(</span><span class="n">PORT</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">rest</span><span class="o">(</span><span class="n">HttpConstants</span><span class="o">.</span><span class="na">TEST_URL_1</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">CamelConstants</span><span class="o">.</span><span class="na">DIRECT_TEST_ROUTE_1</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 4: Create the interfaces and the implementations that we&rsquo;re going to use in our route.</p>

<p>Here we&rsquo;re creating four things:</p>

<ol>
<li>The interface that we&rsquo;re implementing that handles the route (<code>SayHello1</code>) that gets injected with Guice via JNDI.  This interface doesn&rsquo;t do anything other than give Guice a way to reference implementations of it.</li>
<li>An implementation of that interface (<code>BasicSayHello1</code>).  Also, <code>BasicSayHello1</code> is going to have a dependency that we want injected with Guice to make the example more complete.</li>
<li>The interface for the class that we want Guice to inject (<code>MessageHandler</code>)</li>
<li>The implementation that gets injected (<code>BasicMessageHandler</code>)</li>
</ol>


<figure class='code'><figcaption><span>com.timmattison.jndibeans.interfaces.SayHello1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">jndibeans</span><span class="o">.</span><span class="na">interfaces</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.Processor</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SayHello1</span> <span class="kd">extends</span> <span class="n">Processor</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.jndibeans.BasicSayHello1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">jndibeans</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.interfaces.MessageHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.Exchange</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicSayHello1</span> <span class="kd">implements</span> <span class="n">SayHello1</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MessageHandler</span> <span class="n">messageHandler</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">BasicSayHello1</span><span class="o">(</span><span class="n">MessageHandler</span> <span class="n">messageHandler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">messageHandler</span> <span class="o">=</span> <span class="n">messageHandler</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Exchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">exchange</span><span class="o">.</span><span class="na">getOut</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="n">messageHandler</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.nonjndibeans.interfaces.MessageHandler</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">nonjndibeans</span><span class="o">.</span><span class="na">interfaces</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/28/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MessageHandler</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.nonjndibeans.BasicMessageHandler</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">nonjndibeans</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.interfaces.MessageHandler</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/28/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicMessageHandler</span> <span class="kd">implements</span> <span class="n">MessageHandler</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">input</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 5: Create the direct route that handles the route from <code>RestRoutes</code></p>

<figure class='code'><figcaption><span>com.timmattison.DirectTestRoutes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello2</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello3</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.builder.RouteBuilder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectTestRoutes</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">from</span><span class="o">(</span><span class="n">CamelConstants</span><span class="o">.</span><span class="na">DIRECT_TEST_ROUTE_1</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">beanRef</span><span class="o">(</span><span class="n">SayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 6: Create a Guice module that extends <code>CamelModuleWithMatchingRoutes</code>.  I bound my SayHello1 interface to BasicSayHello1, MessageHandler to BasicMessageHandler, and included my RestRoutes and DirectTestRoutes.</p>

<figure class='code'><figcaption><span>com.timmattison.CamelGuiceApplicationModule</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.BasicSayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.BasicMessageHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.interfaces.MessageHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.guice.CamelModuleWithMatchingRoutes</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelGuiceApplicationModule</span> <span class="kd">extends</span> <span class="n">CamelModuleWithMatchingRoutes</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">configure</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">SayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">BasicSayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">MessageHandler</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">BasicMessageHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">RestRoutes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">DirectTestRoutes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if you don&rsquo;t want Guice to handle any external JNDI bindings then you&rsquo;re done.  You can run this application as-is and it will serve up the RESTlet route.  You can test it by using cURL like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> curl http://localhost:8000/test1
</span><span class='line'><span class="go">Hello com.timmattison.jndibeans.BasicSayHello1!</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to have Guice handle JNDI bindings you can easily add those into your module.  For example, if I wanted to be able to get an instance of <code>SayHello1</code> by using the JNDI name <code>sayHello1FromGuice</code> I could add this to my module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@Provides</span>
</span><span class='line'>    <span class="nd">@JndiBind</span><span class="o">(</span><span class="s">&quot;sayHello1FromGuice&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">SayHello1</span> <span class="nf">sayHello1FromGuice</span><span class="o">(</span><span class="n">Injector</span> <span class="n">injector</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">SayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This tells JNDI that our Guice provider will handle any JNDI requests for this name.  Luckily, we didn&rsquo;t have to create any of these manually because Guice automatically creates JNDI bindings for anything that you&rsquo;ve called <code>bind</code> on using its class name.</p>

<p>For example there is an automatic JNDI binding for <code>com.timmattison.jndibeans.interfaces.SayHello1</code> because we called <code>bind(SayHello1.class).to(BasicSayHello1.class)</code>.  If we ever want an instance of whatever Guice has bound to this we can ask JNDI for it using <code>SayHello1.class.getName()</code>.</p>

<p>You&rsquo;ll notice that in our <code>DirectTestRoutes</code> class we routed the direct test route to <code>beanRef</code> with the parameter <code>SayHello1.class.getName()</code>.  That&rsquo;s all you need to do as you add more classes to your Camel routes.</p>

<p>Want to try this out without building everything from scratch?  Head over to <a href="http://github.com/timmattison/apache-camel-guice">my apache-camel-guice repo on Github</a>.</p>

<p>Good luck!  Don&rsquo;t forget to post in the comments!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/09/17/hacking-together-a-super-simple-webserver-with-netcat-on-a-raspberry-pi/">Hacking Together a Super Simple Webserver With Netcat on a Raspberry Pi</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-17T08:08:38-04:00" pubdate data-updated="true">Sep 17<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/09/17/hacking-together-a-super-simple-webserver-with-netcat-on-a-raspberry-pi/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/09/17/hacking-together-a-super-simple-webserver-with-netcat-on-a-raspberry-pi/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few months ago I wanted to get some data out of <a href="http://www.itwatchdogs.com/climate-monitor-weathergoose-ii-p1.html">WeatherGoose II Climate Monitor</a> so I could convert it into JSON and consume it in another application.  I hacked something together and converted their format to JSON in a few hours as a proof-of-concept and the code sat for a few months.</p>

<p>A co-worker recently asked me if they could hook up to my script with a browser to try to do some visualization.  I didn&rsquo;t want to install Apache or nginx as a front end and I didn&rsquo;t want to modify the script to run its own webserver so I came up with a one-liner that uses netcat to get the output of my script into their browser.</p>

<p>But wait!  netcat has an option for this.  However, on the Raspberry Pi it is not available and I didn&rsquo;t want to start downloading new versions.</p>

<p>Here it is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">SCRIPT=&quot;./weathergoose.py 192.168.1.99&quot; &amp;&amp; PORT=&quot;8080&quot; &amp;&amp; while true; do $SCRIPT | nc -l -p $PORT; done</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll need to set <code>SCRIPT</code> to the script you want to run (including any parameters it needs) and <code>PORT</code> to the port you want to listen on.</p>

<p>Be careful!  This is not a real webserver.  This just spits your scripts output back to the browser.  Anything the browser sends to the script is ignored.</p>

<p>Also, the script runs first and pipes its output to netcat.  This happens before netcat accepts a connection and can cause some confusion.  Here&rsquo;s a concrete example.</p>

<p>Assume I wrote a script that just returns the time.  If I use the above snippet and start it at 5:00 PM but I hit it with my web browser at 5:15 PM the time that I get back will be 5:00 PM.  The next time I hit it it will be 5:15 PM.  The easiest way to think about it is that you get the data from when the script started or at the time of the <em>previous</em> request, whichever is later.</p>

<p>I hope to come up with a fix for this issue but I haven&rsquo;t had the time yet.  Do you have a fix?  Does this work for you?  Post in the comments below.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/09/12/the-first-bitcoin-transaction/">The First Bitcoin Transaction</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-12T18:35:01-04:00" pubdate data-updated="true">Sep 12<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/09/12/the-first-bitcoin-transaction/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/09/12/the-first-bitcoin-transaction/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><link rel="stylesheet" type="text/css" href="/javascripts/libs/hexpile/Hexpile.css" /></p>

<script type="text/javascript" language="javascript" src="/javascripts/libs/hexpile/Hexpile.nocache.js"></script>


<p>Want to understand how Bitcoin transactions work?  Follow my next couple of posts for step-by-step explanations of what is going on behind the scenes.</p>

<p>NOTE: These posts are going to be extremely technical.</p>

<p>In this post I&rsquo;m going to explain the very first Bitcoin transaction in excruciating detail.  The first Bitcoin transaction is not the first block ever mined.  The first Bitcoin transaction occurred in block 170 when the first Bitcoins were transferred from one address to another.</p>

<p>Each Bitcoin block contains transactions.  The first transaction is called the coinbase and is a transaction that actually mines/creates new Bitcoins.  All transactions after that are some kind of balance transfer from a set of addresses to another set of addresses.</p>

<p>Here is the <a href="https://blockchain.info/tx/f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16">first, non-mining transaction from block 170</a>:</p>

<div id="hexpile_tx_f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16">
<pre>
Version number: 01000000

Input counter: 01
Input script #0: c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd3704000000004847304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d090147304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901ffffffff

Output counter: 02
Output script #0: 00ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac
Output script #1: 00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
</pre>
</div>


<div id="hexpile_tx_f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16_output"></div>


<p>Version number is the little endian representation of the version number of this transaction.  Future transactions in a different format could have a different version number so they can be processed in new ways.</p>

<p>Input counter tells us that we should expect 1 input.</p>

<p>Input script #0 contains all the bytes in our input script.</p>

<p>Output coutner tells us that we should expect 2 outputs.</p>

<p>Output scripts #0 and #1 contain all the bytes in the two output scripts in this transaction.  These outputs show where the Bitcoins are going.  In this case they&rsquo;re being sent to two different addresses.</p>

<p>Let&rsquo;s look at the input first.</p>

<div id="hexpile_tx_f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16_input_0">
<pre>
Previous transaction hash: c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd3704
Previous output index: 00000000
Length: 0x48
VIRTUAL_OP_PUSH: 0x47
Bytes to push: 304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901
Sequence number: ffffffff
</pre>
</div>


<div id="hexpile_tx_f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16_input_0_output"></div>


<p>Previous transaction hash tells us where to find the transaction that this input is working on.  This transaction hash refers to the coinbase in <a href="https://blockchain.info/tx/0437cd7f8525ceed2324359c2d0ba26006d92d856a9c20fa0241106ee5a597c9">block 9</a> which mined 50 BTC.</p>

<p>Previous output index tells us which output script in the transaction we should apply this input script to.  In this transaction in block 9 there was only one output.</p>

<p>Length tells us the number of bytes that are coming up in our input script.  In this case it is <code>0x48</code> or 72 bytes.</p>

<p>Now we&rsquo;re at the actual input script.  This input script consists of a single operation (<code>VIRTUAL_OP_PUSH</code>) which pushes a 71 byte value onto the stack.  That 71 byte value is a signature that signs the previous output and the new output so that we make sure know that the person unlocking the coins is the same person spending the coins.</p>

<p>Bitcoin uses the ECC curve <a href="https://en.bitcoin.it/wiki/Secp256k1">secp256k1</a> which is part of the <a href="http://perso.univ-rennes1.fr/sylvain.duquesne/master/standards/sec2_final.pdf">SEC 2: Recommended Elliptic Curve Domain Parameters</a>.  Therefore all signing and validation operations are performed with the parameters from this curve.</p>

<p>The really interesting part is how we do the transaction validation.  That requires a lot of explanation&hellip; as if this wasn&rsquo;t long and complicated enough already.</p>

<p>Let&rsquo;s look at the output script from block 9:</p>

<div id="hexpile_tx_0437cd7f8525ceed2324359c2d0ba26006d92d856a9c20fa0241106ee5a597c9_output_0">
<pre>
VIRTUAL_OP_PUSH: 0x41
Bytes to push: 0411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3
OP_CHECKSIG: 0xac
</pre>
</div>


<div id="hexpile_tx_0437cd7f8525ceed2324359c2d0ba26006d92d856a9c20fa0241106ee5a597c9_output_0_output"></div>


<p>This script pushes a value onto the stack (which happens to be a public key) and the calls <code>OP_CHECKSIG</code>.  This is called a <a href="https://en.bitcoin.it/wiki/Script#Obsolete_pay-to-pubkey_transaction">pay-to-pubkey transaction</a>.  Simply it says that anyone who can create a signed transaction with a certain public key can spend this output.</p>

<p><code>OP_CHECKSIG</code> does four things:</p>

<ol>
<li>Pops a value off of the stack and calls it the public key</li>
<li>Pops a value off of the stack and calls it the signature</li>
<li>Grabs data from the previous transaction and the current transaction and combines it in a particular way</li>
<li>Computes and checks that the data from step #3 matches the public key and signature from steps #1 and #2</li>
</ol>


<p>Now we concatenate the input and output scripts into one larger script and get this:</p>

<div id="hexpile_validation_script">
<pre>
VIRTUAL_OP_PUSH - 71 bytes: 0x47
Signature from block 170: 304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901

VIRTUAL_OP_PUSH - 65 bytes: 0x41
Public key from block 9: 0411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3

OP_CHECKSIG: ac
</pre>
</div>


<div id="hexpile_validation_script_output"></div>


<p>This is the most straightforward part of the process.  We are pushing the data from the input script from block 170 and then pushing the data from the output script from block 9 and executing <code>OP_CHECKSIG</code>.  This ordering makes sure that the person that originally had the Bitcoins maintains control over the final execution.  Otherwise it would be possible for an attacker to just dump everything off of the stack except for a final value of 1 which would unlock the coins.</p>

<p>When the Bitcoin state machine sees <code>OP_CHECKSIG</code> then the real work begins.</p>

<p>From above we know we pop the public key off of the stack and then pop the signature off of the stack.  Now we need to understand step #3 where we find the data that we&rsquo;re checking the signature of.</p>

<p>Step 1 &ndash; Get a copy of the previous transaction script data/output transaction script data (<code>VIRTUAL_OP_PUSH</code> and <code>OP_CHECKSIG</code>) which will be</p>

<div id="hexpile_step_1">
<pre>
VIRTUAL_OP_PUSH: 0x41
Bytes to push: 0411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3
OP_CHECKSIG: 0xac
</pre>
</div>


<div id="hexpile_step_1_output"></div>


<p>We will refer to this as our &ldquo;new input script&rdquo;.</p>

<p>Step 2 &ndash; Get a copy of the current transaction (again, <a href="https://blockchain.info/tx/f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16">from block 170</a>)</p>

<div id="hexpile_step_2">
<pre>
Current transaction: 0100000001c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd3704000000004847304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901ffffffff0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
</pre>
</div>


<div id="hexpile_step_2_output"></div>


<p>Step 3 &ndash; Clear out all of the inputs&#8217; script data from this transaction</p>

<p>Before:</p>

<div id="hexpile_step_3a">
<pre>
:0100000001c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd370400000000
Section to remove: 4847304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901
:ffffffff0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
</pre>
</div>


<div id="hexpile_step_3a_output"></div>


<p>After:</p>

<div id="hexpile_step_3b">
<pre>
:0100000001c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd370400000000
NULL placeholder: 00
:ffffffff0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
</pre>
</div>


<div id="hexpile_step_3b_output"></div>


<p>The &ldquo;after&rdquo; block translates to:</p>

<div id="hexpile_step_3c">
<pre>
Version number: 01000000
Input counter: 01

Remaining data from input #0: c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd37040000000000ffffffff

Output counter: 02
Output script #0: 00ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac

Output script #1: 00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
</pre>
</div>


<div id="hexpile_step_3c_output"></div>


<p>Step 4 &ndash; Now remove all of the OP_CODESEPARATORS from the new input script.  In block 170 there aren&rsquo;t any of them so the new input script doesn&rsquo;t change.</p>

<p>Step 5 &ndash; Put the new input script into the signing data at the current input number.  In step #3 this means the new input script goes where the NULL placeholder was.  This yields:</p>

<div id="hexpile_step_5">
<pre>
:0100000001c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd37040000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3acffffffff0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
</pre>
</div>


<div id="hexpile_step_5_output"></div>


<p>Which translates to:</p>

<div id="hexpile_step_5_detail">
<pre>
Version number: 01000000
Input counter: 01
Previous transaction hash: c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd3704
Previous output index: 00000000
Input script length: 0x43
VIRTUAL_OP_PUSH Input #0: 0x41
Bytes to push Input #0: 0411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3
OP_CHECKSIG Input #0: 0xac
Sequence number: ffffffff

Value bytes: 00ca9a3b00000000
Output script length: 0x43
VIRTUAL_OP_PUSH Output #0: 0x41
Bytes to push Output #0: 04ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84c
OP_CHECKSIG Output #0: 0xac

Value bytes: 00286bee00000000
Output script length: 0x43
VIRTUAL_OP_PUSH Output #1: 0x41
Bytes to push Output #1: 0411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3
OP_CHECKSIG Output #1: 0xac
Lock time: 00000000
</pre>
</div>


<div id="hexpile_step_5_detail_output"></div>


<p>The value bytes represent the number of Satoshi (1 / 100,000,000th of a Bitcoin) are being transferred.  The input was a mined block that created 50 BTC and the two output blocks are getting 10 and 40 BTC, respectively.  Like all other value types in Bitcoin these values are little-endian.</p>

<p>Step 6 &ndash; Add the 32-bit little endian representation of the hash type onto the end of the signing data.  The hash type is the last byte of the signature which is <code>0x01</code> in this case.  Expanded into a 32-bit little endian value makes it <code>0x01000000</code>.  So our final data that needs to be signed is:</p>

<div id="hexpile_step_6">
<pre>
:0100000001c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd37040000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3acffffffff0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000
Hash type: 01000000
</pre>
</div>


<div id="hexpile_step_6_output"></div>


<p>If the signature from block 170 is a valid signature for this blob of binary data we just created, using the public key from block 9, then the transaction is valid.</p>

<p>Questions?  Comments?  Post below!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/09/04/rid-yourself-of-smart-quotes-smart-dashes-and-automatic-spelling-correction-on-mac-os/">Rid Yourself of Smart Quotes, Smart Dashes, and Automatic Spelling Correction on Mac OS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-04T08:45:12-04:00" pubdate data-updated="true">Sep 4<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/09/04/rid-yourself-of-smart-quotes-smart-dashes-and-automatic-spelling-correction-on-mac-os/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/09/04/rid-yourself-of-smart-quotes-smart-dashes-and-automatic-spelling-correction-on-mac-os/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever pasted working a bash script or piece of code into a text editor and had it fail to work when you copied it back out later?  You&rsquo;ve probably fallen victim to smart quotes, smart dashes, or automatic spelling correction.</p>

<p>For example, during development I write scripts in Evernote and two very common things happen:</p>

<ul>
<li><code>aws</code> is persistently and annoyingly replaced by the word &ldquo;was&rdquo;</li>
<li>Commands that include double or single quotes have those quotes replaced with scripting hostile quotes that shells don&rsquo;t understand</li>
</ul>


<p>In Mac OS we can fix this in a few steps:</p>

<ol>
<li>Open System Preferences and click on Keyboard <img src="images/smart-quotes-mac-os/step-1.png" alt="Keyboard" /></li>
<li>Click &ldquo;Text&rdquo; <img src="images/smart-quotes-mac-os/step-2.png" alt="Keyboard" /></li>
<li>Uncheck &ldquo;Use smart quotes and dashes&rdquo; <img src="images/smart-quotes-mac-os/step-3.png" alt="Keyboard" /></li>
<li>Uncheck &ldquo;Correct spelling automatically&rdquo; <img src="images/smart-quotes-mac-os/step-4.png" alt="Keyboard" /></li>
</ol>


<p>You&rsquo;re done!  Now your settings should look like this and these &ldquo;smart&rdquo; features will never bother you again:</p>

<p><img src="images/smart-quotes-mac-os/step-5.png" alt="Keyboard" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/09/04/using-ssh-agent-to-simplify-connecting-to-ec2/">Using SSH Agent to Simplify Connecting to EC2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-04T08:00:41-04:00" pubdate data-updated="true">Sep 4<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/09/04/using-ssh-agent-to-simplify-connecting-to-ec2/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/09/04/using-ssh-agent-to-simplify-connecting-to-ec2/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>TL;DR &ndash; Jump to the bottom and look for the <code>eval $(ssh-agent)</code> snippet!</p>

<p>Once you start using EC2 you&rsquo;ll probably need to do a lot of things that involve SSH.  A common frustration is having to specify your identity file when connecting to your EC2 instance.  Instead of doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">ssh ubuntu@my-ec2-instance</span>
</span></code></pre></td></tr></table></div></figure>


<p>You end up doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">ssh -i ~/.ssh/identity-file.pem ubuntu@my-ec2-instance</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gets even more complex when tools based on SSH are brought into the mix.  Some of these tools don&rsquo;t have a mechanism to even specify the identity file.  If they do sometimes it makes the command-line really ugly and it almost always makes the script custom to a specific user.  For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">rsync -avz -e &quot;ssh -p1234  -i /home/username/.ssh/identity-file.pem&quot; ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Is only going to work for the user <code>username</code>.</p>

<p>How do we make this a lot easier?  It turns out there is a very simple way to make all of that pain go away.  Whether you use <a href="http://rsync.samba.org/">rsync</a>, <a href="http://www.cis.upenn.edu/~bcpierce/unison/">unison</a>, <a href="https://mosh.mit.edu/">mosh</a>, scp, or any of a number of other tools that make use of SSH under the hood there is a standard mechanism for SSH to manage your identity.  That mechanism is called <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man1/ssh-agent.1?query=ssh-agent&amp;sec=1">ssh-agent</a>.</p>

<p>If I try to rsync directly to my EC2 instance I get this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> rsync -avzP ubuntu@my-ec2-instance:file-on-ec2.txt <span class="nb">local</span>-file.txt
</span><span class='line'><span class="go">Permission denied (publickey).</span>
</span><span class='line'><span class="go">rsync: connection unexpectedly closed (0 bytes received so far) [Receiver]</span>
</span><span class='line'><span class="go">rsync error: unexplained error (code 255) at io.c(226) [Receiver=3.1.1]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead what I want to do is start the ssh-agent, tell it about my identity file, and have the agent worry about providing my identity file when necessary.  To do that I do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">eval $(ssh-agent) &amp;&amp; ssh-add ~/.ssh/identity-file.pem</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you do that SSH will use that identity file to connect to EC2 automatically.  You just need to run that in each shell you are using to connect to EC2 and you are set.</p>

<p>Do you have more than one identity file?  You can keep running ssh-add with additional identity files and it will manage them all.</p>

<p>Do you want to be really lazy and load all of your identities at once?  Try this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">eval $(ssh-agent) &amp;&amp; ssh-add ~/.ssh/*.pem</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enjoy!</p>

<p>NOTE: Your pem files need to have the permission set to 400 so they can only be read by your user and not written to.  Otherwise ssh-agent and ssh may refuse to use them.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/2/">&larr; Older</a>
    
    <a href="/archives">Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
	<h1>Like this site/article?  Donate with Bitcoin!</h1>
	<a href="bitcoin:1PcYJnuZPZFWUMUHzzBGHHshEbrVzYpY9Y"><img src="http://blockchain.info/qr?data=1PcYJnuZPZFWUMUHzzBGHHshEbrVzYpY9Y&size=200" alt="Bitcoin"></a>
	<a href="bitcoin:1PcYJnuZPZFWUMUHzzBGHHshEbrVzYpY9Y">1PcYJnuZPZFWUMUHzzBGHHshEbrVzYpY9Y</a>
</section>
<section>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar -->
<ins class="adsbygoogle"
     style="display:inline-block;width:120px;height:240px"
     data-ad-client="ca-pub-9307090849713032"
     data-ad-slot="1616086903"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/2014/12/16/mockito-and-servletinputstreams/">Mockito and ServletInputStreams</a>
      </li>
    
      <li class="post">
        <a href="/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/">Fixing Javac on Mac OS When Multiple JVMs Are Installed</a>
      </li>
    
      <li class="post">
        <a href="/archives/2014/11/12/when-unicode-goes-wrong-in-java/">When Unicode Goes Wrong in Java</a>
      </li>
    
      <li class="post">
        <a href="/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/">Using Interfaces in Camel&#8217;s Java DSL With Spring</a>
      </li>
    
      <li class="post">
        <a href="/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/">Activating U2F on a Yubikey Neo on Mac OS</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/timmattison">@timmattison</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'timmattison',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/timmattison?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Tim Mattison -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'timmattison';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
