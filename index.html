
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tim Mattison</title>
  <meta name="author" content="Tim Mattison">

  
  <meta name="description" content="UPDATE: I briefly talked to Nick Humrich and Abhishek K Singh on Twitter, pointed them to this article, and it was fixed in less than 24 hours. Nice &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.timmattison.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tim Mattison" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<script type="text/javascript">
/* <![CDATA[ */
    (function() {
        var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
        s.type = 'text/javascript';
        s.async = true;
        s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
        t.parentNode.insertBefore(s, t);
    })();
/* ]]> */
</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46746763-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tim Mattison</a></h1>
  
    <h2>Hardcore tech</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.timmattison.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2015/07/27/deploying-multiple-war-files-on-a-single-instance-with-elastic-beanstalks-command-line-tools/">Deploying Multiple WAR Files on a Single Instance With Elastic Beanstalk&#8217;s Command-line Tools</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-27T17:22:30-04:00" pubdate data-updated="true">Jul 27<span>th</span>, 2015</time>
        
           | <a href="/archives/2015/07/27/deploying-multiple-war-files-on-a-single-instance-with-elastic-beanstalks-command-line-tools/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2015/07/27/deploying-multiple-war-files-on-a-single-instance-with-elastic-beanstalks-command-line-tools/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong><em>UPDATE</em></strong>: I briefly talked to <a href="https://twitter.com/nhumrich">Nick Humrich</a> and <a href="https://twitter.com/abhik5ingh">Abhishek K Singh</a> on Twitter, pointed them to this article, and it was fixed in less than 24 hours.  Nice work!  If you update your EB CLI tools to 3.4.7 or greater the bug will be fixed for you and you can ignore the rest of this article.</p>

<p>In June this year <a href="http://aws.amazon.com/about-aws/whats-new/2015/06/aws-elastic-beanstalk-supports-multiple-war-files-and-m4-instances/">AWS added the ability to run multiple WAR files with Elastic Beanstalk in a single EC2 instance</a>.  This makes deploying several small applications a lot more cost effective.</p>

<p>In order to do this you need to create a ZIP file containing all of the WAR files you want to deploy and you <strong><em>must</em></strong> include a directory called <code>.ebextensions</code> even if it is empty.  In my case I just added and empty file called <code>.ebextensions/README.md</code> to make it happy.  Obviously if you use <code>.ebextensions</code> for any kind of customization you won&rsquo;t need to do anything.</p>

<p>When Elastic Beanstalk sees that you&rsquo;ve deployed a file like this it treats it differently than a normal bundle.  It takes the WAR file called <code>ROOT.war</code> and deploys that as the root application.  The rest of the WAR files are deployed in directories derived from their file names.  For example, <code>application1.war</code> would be accessed through the <code>/application1</code> path.</p>

<p>Deploying with <code>eb deploy</code> creates a ZIP file that includes everything in your current directory.  The problem is that <code>eb init</code> creates a <code>.gitignore</code> file in your deployment directory.  <code>eb deploy</code> picks that up that <code>.gitignore</code> and adds it to the archive.  On the EC2 instance that runs your application it sees that your archive doesn&rsquo;t contain just WAR files and the <code>.ebextensions</code> directory and it treats it like a normal single application deployment.  If/when this happens you&rsquo;ll see that you just get your WAR files placed in the <code>/var/lib/tomcat8/webapps/ROOT</code> directory.</p>

<p>There are two possible fixes for this problem.</p>

<p>Solution #1: You can just delete the <code>.gitignore</code> file.  IMHO, this isn&rsquo;t a great solution since you need to remember to do it for each project.</p>

<p>Solution #2: You can patch the Python code that creates the ZIP archive and tell it to ignore the <code>.gitignore</code> file.  To do that you need to modify your <code>ebcli/core/fileoperations.py</code> file.  On my system, since I&rsquo;m not using <code>pip</code>, it was located at <code>~/.ebvenv/lib/python2.7/site-packages/ebcli/core/fileoperations.py</code>.  If you use <code>pip</code> or another package manager it will probably be in a different location.</p>

<p>The function you need to modify is called <code>zip_up_folder</code>.  My original version looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">zip_up_folder</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span class='line'>        <span class="n">io</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s">&#39;Zipping up folder at location: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
</span><span class='line'>        <span class="n">zipf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
</span><span class='line'>        <span class="n">_zipdir</span><span class="p">(</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="n">zipf</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="n">ignore_list</span><span class="p">)</span>
</span><span class='line'>        <span class="n">zipf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;File size: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">location</span><span class="p">)))</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code I added to set up the ignore_list is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">if</span> <span class="n">ignore_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>        <span class="n">ignore_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="n">ignore_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;.gitignore&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So my updated function looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">zip_up_folder</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span class='line'>        <span class="n">io</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="s">&#39;Zipping up folder at location: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
</span><span class='line'>        <span class="n">zipf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">ignore_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>            <span class="n">ignore_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="n">ignore_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;.gitignore&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">_zipdir</span><span class="p">(</span><span class="s">&#39;./&#39;</span><span class="p">,</span> <span class="n">zipf</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="n">ignore_list</span><span class="p">)</span>
</span><span class='line'>        <span class="n">zipf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;File size: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">location</span><span class="p">)))</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>After updating that code and doing another <code>eb deploy</code> my set of WARs were all happily running in a single EC2 instance as I&rsquo;d expect.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2015/07/24/how-would-you-implement-cron-on-aws-as-inexpensively-as-possible/">How Would You Implement &#8220;Cron&#8221; on AWS as Inexpensively as Possible?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-24T09:20:15-04:00" pubdate data-updated="true">Jul 24<span>th</span>, 2015</time>
        
           | <a href="/archives/2015/07/24/how-would-you-implement-cron-on-aws-as-inexpensively-as-possible/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2015/07/24/how-would-you-implement-cron-on-aws-as-inexpensively-as-possible/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There seems to be a common problem I&rsquo;ve seen in app developer threads.  CloudKit provides tons of functionality to run your app without your own infrastructure but it only runs the APIs they provide.  There is an Android syncing API that provides similar things but with the same limitations.  Lots of app developers are really cheap because they&rsquo;re testing the water to see if their app is worth spending money on or not.</p>

<p>The problem: You need to do some simple processing on a data set and give the processed data set to your users.</p>

<p>The solution: Run a scheduled job that processes the data and puts it in S3.</p>

<p>The constraints:  You must use AWS.  The cost must be under $9 / month (less than a t2.micro) and cheaper is better.  You can&rsquo;t run it on your laptop/Raspberry Pi.  It must run at least once per day.</p>

<p>I think it&rsquo;s a fun exercise to see how this problem can be solved.  As I&rsquo;m learning more and more about AWS there seem to be multiple ways to do it so I&rsquo;m interested in seeing what other people come up with.</p>

<p>Some possible solutions I&rsquo;ve seen so far:</p>

<ul>
<li><p><a href="https://www.youtube.com/watch?v=UFj27laTWQA&amp;feature=youtu.be&amp;t=42m50s">AWS Lambda plans to offer support for &ldquo;timed events&rdquo;</a> but it isn&rsquo;t there yet</p></li>
<li><p>The <a href="https://alestic.com/2015/05/aws-lambda-recurring-schedule/">Unreliable Town Clock setup</a>, another AWS Lambda technique</p></li>
<li><p><a href="http://stackoverflow.com/a/31415241/796579">SQS, plus CloudWatch, plus SNS, plus Lambda</a>, sounds elaborate but actually this is my favorite so far since it is available now and doesn&rsquo;t depend on the Unreliable Town Clock.  However, there are gotchas with it.</p></li>
</ul>


<p>How would you do it?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2015/03/10/validating-guava-event-bus-interactions-with-mockito/">Validating Guava Event Bus Interactions With Mockito</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-10T18:43:15-04:00" pubdate data-updated="true">Mar 10<span>th</span>, 2015</time>
        
           | <a href="/archives/2015/03/10/validating-guava-event-bus-interactions-with-mockito/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2015/03/10/validating-guava-event-bus-interactions-with-mockito/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Are you using <a href="https://code.google.com/p/guava-libraries/wiki/EventBusExplained">Guava&rsquo;s event bus</a> in your Java project?  Do you need to test and validate interactions with the event bus but are having trouble?  Mockito can help you out here with just a few lines of code.</p>

<p>Assume you have two event types.  We&rsquo;ll call them <code>WantedEvent</code> and <code>UnwantedEvent</code>.  In your test you can use Mockito to create a mock event bus like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mockEventBus</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">EventBus</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you can use Mockito&rsquo;s <code>doAnswer</code> functionality to intercept all interactions with the event bus and do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">doAnswer</span><span class="o">(</span><span class="k">new</span> <span class="n">Answer</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Void</span> <span class="nf">answer</span><span class="o">(</span><span class="n">InvocationOnMock</span> <span class="n">invocationOnMock</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Object</span> <span class="n">argument</span> <span class="o">=</span> <span class="n">invocationOnMock</span><span class="o">.</span><span class="na">getArguments</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">argument</span> <span class="k">instanceof</span> <span class="n">WantedEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">wantedEventCount</span><span class="o">++;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">argument</span> <span class="k">instanceof</span> <span class="n">UnwantedEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">unwantedEventCount</span><span class="o">++;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">&quot;This kind of event was not expected&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}).</span><span class="na">when</span><span class="o">(</span><span class="n">mockEventBus</span><span class="o">).</span><span class="na">post</span><span class="o">(</span><span class="n">anyObject</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you use your event bus in your tests now you&rsquo;ll be counting the number of times <code>WantedEvent</code> and <code>UnwantedEvent</code> are published (you do need to make those variables accessible outside the scope of this anonymous <code>Answer&lt;Void&gt;</code> block).</p>

<p>You&rsquo;ll also be throwing exceptions if you see any other kinds of events that you didn&rsquo;t expect so you can fail immediately if there is additional unwanted behavior going on.  Naturally you can leave the else part out and ignore other events completely too.</p>

<p>Using this simple pattern I&rsquo;ve been able to debug, test, and be confident in the implementation of several projects that use the Guava event bus.</p>

<p>Do you have any tricks or tips related to this article?  Is there a better or easier way to do what I&rsquo;m doing here?  Did this get you out of a bind?  Post in the comments!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/12/16/mockito-and-servletinputstreams/">Mockito and ServletInputStreams</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-16T07:00:22-05:00" pubdate data-updated="true">Dec 16<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/12/16/mockito-and-servletinputstreams/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/12/16/mockito-and-servletinputstreams/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was working on a few applications that involve servlets recently and I came across a situation that initially seemed challenging to test with <a href="https://github.com/mockito/mockito">Mockito</a>.  I wanted to do something relatively simple which was read a <a href="https://github.com/google/protobuf/">Protobuf</a> sent from a client, turn it into an object, and do some processing on it.</p>

<p>The question is how do you test a servlet that needs to get the input stream from a servlet request?</p>

<p>I found <a href="https://stackoverflow.com/questions/13353545/mocking-multipart-mime-request-with-mockito">a Stack Overflow post that addresses how to do this with an older version of the ServletInputStream</a> but doing it now requires that you override three additional methods (<code>isFinished</code>, <code>isReady</code>, and <code>setReadListener</code>).</p>

<p>My issue with this is that I don&rsquo;t want to override those methods because I don&rsquo;t really know what I want them to do.  If I&rsquo;m mocking something I want to make sure I know when and where it will be used or I want the mocking framework to return default values or throw exceptions so I know where to look when something breaks.</p>

<p>What I landed on was using the <code>thenAnswer</code> method like this:</p>

<figure class='code'><figcaption><span>Mocking a ServletInputStream</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">byte</span><span class="o">[]</span> <span class="n">myBinaryData</span> <span class="o">=</span> <span class="s">&quot;TEST&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
</span><span class='line'><span class="n">ByteArrayInputStream</span> <span class="n">byteArrayInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">myBinaryData</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'><span class="n">mockServletInputStream</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">ServletInputStream</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">when</span><span class="o">(</span><span class="n">mockServletInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="n">any</span><span class="o">(),</span> <span class="n">anyInt</span><span class="o">(),</span> <span class="n">anyInt</span><span class="o">())).</span><span class="na">thenAnswer</span><span class="o">(</span><span class="k">new</span> <span class="n">Answer</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">answer</span><span class="o">(</span><span class="n">InvocationOnMock</span> <span class="n">invocationOnMock</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">invocationOnMock</span><span class="o">.</span><span class="na">getArguments</span><span class="o">();</span>
</span><span class='line'>        <span class="kt">byte</span><span class="o">[]</span> <span class="n">output</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">byteArrayInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you need to ever mock a ServletInputStream feel free to use this code to do it.  So far it has worked perfectly for me.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/">Fixing Javac on Mac OS When Multiple JVMs Are Installed</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-12T06:59:45-05:00" pubdate data-updated="true">Nov 12<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For some reason I decided to install the Java 8 JDK a few days ago when I upgraded to Yosemite.  In IntelliJ it isn&rsquo;t a problem but on the command-line it isn&rsquo;t so nice.  Here&rsquo;s what I get when I try to use javac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> javac src/com/timmattison/Main.java
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/Object.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/String.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/Object.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;: class file for jdk.Profile+Annotation not found</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/String.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/AutoCloseable.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/AutoCloseable.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/System.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/lang/System.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/PrintStream.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/PrintStream.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/FilterOutputStream.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span><span class='line'><span class="go">/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/FilterOutputStream.class): warning: Cannot find annotation method &#39;value()&#39; in type &#39;Profile+Annotation&#39;</span>
</span><span class='line'><span class="go">warning: /Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home/lib/ct.sym(META-INF/sym/rt.jar/java/io/OutputStream.class): major version 52 is newer than 51, the highest major version supported by this compiler.</span>
</span><span class='line'><span class="go">It is recommended that the compiler be upgraded.</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I run <code>javac -version</code> I get mostly what I&rsquo;d expect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> javac -version
</span><span class='line'><span class="go">javac 1.7.0_45</span>
</span></code></pre></td></tr></table></div></figure>


<p>So why is it trying to use libraries from the Java 8 JDK?  Simply because I forgot to set JAVA_HOME.  On Mac OS you can quickly fix this by adding the following line to your .bash_profile and starting a new Terminal session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">export JAVA_HOME=&quot;/Library/Java/JavaVirtualMachines/jdk1.7.0_45.jdk/Contents/Home/&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course you should change <code>_45</code> to reflect the specific version you&rsquo;re running and validate that the path in the <code>JAVA_HOME</code> variable exists.</p>

<p>Good luck!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/11/12/when-unicode-goes-wrong-in-java/">When Unicode Goes Wrong in Java</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-12T06:50:31-05:00" pubdate data-updated="true">Nov 12<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/11/12/when-unicode-goes-wrong-in-java/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/11/12/when-unicode-goes-wrong-in-java/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>NOTE: This is only guaranteed to work with the Sun JVM since this option is <a href="https://stackoverflow.com/questions/2168350/java-charset-problem-on-linux?answertab=votes#tab-top">&ldquo;an internal detail of Sun&rsquo;s implementations&rdquo;</a>.</p>

<p>UPDATE 2014-11-12 6:22 PM: The real fix is to set the environment variable LANG to <code>en_US.UTF-8</code> right before you start your JVM.</p>

<p>Is Unicode breaking in your application and you can&rsquo;t figure out where?  Maybe data from HttpClient is coming back mangled, maybe database queries via JDBC are having Unicode data replaced with question marks, maybe your <a href="https://code.google.com/p/protobuf/">protobufs</a> are getting shredded, but somewhere something is eating your Unicode data and nothing you&rsquo;ve tried fixes it.  Well&hellip;</p>

<p>Did you know the JVM itself has a global Unicode setting specified by the <code>-Dfile.encoding</code> option?  Most people I talked to didn&rsquo;t know about it, myself included, when I ran into a Unicode issue on a project.  After some great teamwork and research we found this option, set it, and everything started working again.</p>

<p>All we had to do was put <code>-Dfile.encoding=UTF8</code> in the script that ran our JVM and everything was fixed but that was only a temporary fix.  You really need to set LANG to <code>en_US.UTF-8</code>.  If you want to play with it <a href="https://github.com/timmattison/jvm-unicode-settings">I created a test project on Github</a> that is incredibly simple and shows the right and wrong settings and what they do to a simple trademark symbol.  Otherwise, try this on your project and see if it fixes the issue.</p>

<p>Good luck!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/">Using Interfaces in Camel&#8217;s Java DSL With Spring</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-30T16:29:26-04:00" pubdate data-updated="true">Oct 30<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/10/30/using-interfaces-in-camels-java-dsl-with-spring/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When writing some routes with Camel&rsquo;s Java DSL I came across this exception:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Caused by: java.lang.IllegalStateException: No method invocation could be created, no matching method could be found on: null</span></code></pre></td></tr></table></div></figure>


<p>After a lot of tracing I figured out that it was related to me calling the <code>.bean(...)</code> method with a class that was actually just an interface.  What was happening was that Camel wants to instantiate this class, usually using Spring, but cannot do that if it isn&rsquo;t a concrete implementation.</p>

<p>This proved to be a real problem because I had an interface that had two implementations.  One of these implementations is used for debugging and the other is used for production.  I didn&rsquo;t want to have to manually select which one I was using in my code because that&rsquo;s Spring&rsquo;s job so I came up with a way to do it.</p>

<p>For the complete background here&rsquo;s what my interface looks like:</p>

<figure class='code'><figcaption><span>The interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.Processor</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProtobufToWire</span> <span class="kd">extends</span> <span class="n">Processor</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This converts a Protobuf to our &ldquo;wire&rdquo; format.  That format could be the native protobuf binary format or JSON.  I implement this empty interface in two classes called <code>ProtobufToBinary</code> and <code>ProtobufToJson</code> and I want to use the JSON one only for debugging.</p>

<p>To be clear doing this always fails with the exception I listed above:</p>

<figure class='code'><figcaption><span>A route that always fails</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">from</span><span class="o">(</span><span class="n">SOME_URI</span><span class="o">).</span><span class="na">bean</span><span class="o">(</span><span class="n">ProtobufToWire</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>To fix this I added this to my Java-based Spring config:</p>

<figure class='code'><figcaption><span>Getting an instance of ProtobufToWire</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Bean</span>
</span><span class='line'><span class="kd">public</span> <span class="n">ProtobufToWire</span> <span class="nf">protobufToWire</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">ProtobufToBinary</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now because, I believe, that Camel&rsquo;s <code>bean(...)</code> method doesn&rsquo;t look up the beans with Spring this still fails.  What I needed to where I am defining my routes is this:</p>

<figure class='code'><figcaption><span>Finally, how to get Camel to instantiate the right type</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@Autowired</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">ProtobufToWire</span> <span class="n">protobufToWire</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">from</span><span class="o">(</span><span class="n">SOME_URI</span><span class="o">).</span><span class="na">bean</span><span class="o">(</span><span class="n">protobufToWire</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What I&rsquo;m doing here is getting Spring to autowire an instance of that interface into a private variable and then asking it for its real concrete type.  Part of me says that I shouldn&rsquo;t have to do this but this is what works for me.</p>

<p>Did this help you out?  Do you have a better way to do it?  Post in the comments!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/">Activating U2F on a Yubikey Neo on Mac OS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-28T16:25:12-04:00" pubdate data-updated="true">Oct 28<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/10/28/activating-u2f-on-a-yubikey-neo-on-mac-os/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just got my Yubikey Neo with U2F support and I felt like the documentation on how to get it up and running was a bit hard to find.  If you are having trouble getting started with U2F these few quick steps will help you get through it.</p>

<p>Step 0: Download and install the <a href="https://developers.yubico.com/yubikey-neo-manager/Releases/">Yubikey Neo Manager application</a>.  This is NOT the Yubikey Personalization Tool!  The Yubikey Personalization Tool does not support enabling U2F yet.</p>

<p>Step 1: Open the Yubikey Neo Manager with your Yubikey installed and click <code>Change connection mode [OTP]</code> <img src="/images/yubikey-neo-manager/step-1.png" alt="Yubikey Neo Manager main screen" /></p>

<p>Step 2: On the <code>Change connection mode</code> check the <code>U2F</code> box to change the setting from <code>OTP</code> to <code>U2F</code> and click <code>OK</code>. <img src="/images/yubikey-neo-manager/step-2.png" alt="Yubikey Neo Manager main screen" /> <img src="/images/yubikey-neo-manager/step-3.png" alt="Yubikey Neo Manager main screen" /></p>

<p>The application will now prompt you to remove your device.  You can remove it and plug it back in again.  Close the Yubikey Neo Manager application.</p>

<p>Step 3: Open Chrome and install the <a href="https://chrome.google.com/webstore/detail/fido-u2f-universal-2nd-fa/pfboblefjcgdjicmnffhdgionmgcdmne">FIDO U2F (Universal 2nd Factor) extension</a> from the Chrome web store.</p>

<p>Step 4: Register on <a href="http://demo.yubico.com/u2f">Yubico&rsquo;s U2F demo page</a> and you&rsquo;re done.</p>

<p>Now you can log in on the demo page and other sites that support U2F.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/10/27/building-apache-camel-applications-with-guice/">Building Apache Camel Applications With Guice</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-27T18:40:13-04:00" pubdate data-updated="true">Oct 27<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/10/27/building-apache-camel-applications-with-guice/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/10/27/building-apache-camel-applications-with-guice/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>UPDATE 2015-07-27</strong>: Included instructions to run the project from the command-line</p>

<p><a href="https://camel.apache.org/">Apache Camel</a> is a great framework for implementing <a href="https://camel.apache.org/enterprise-integration-patterns.html">Enterprise Integration Patterns</a>.  However, most of the examples you&rsquo;ll find out there show you how to use it with <a href="http://projects.spring.io/spring-framework/">the Spring framework</a>.  I&rsquo;m much more comfortable with <a href="https://github.com/google/guice">Google Guice</a> since I&rsquo;ve used it in more production projects.</p>

<p>I did find an example of how to use Guice with Apache Camel but it wasn&rsquo;t commented well and involved doing a lot of extra work that didn&rsquo;t provide me any benefits.  So below I&rsquo;ve listed the things that you&rsquo;ll need to do to get Guice and Camel working together.  What we are doing here is setting up Guice as a JNDI provider and automatically loading a Guice CamelModule via JNDI.</p>

<p>Step 1: Create a <code>jndi.properties</code> file in your project&rsquo;s <code>resources</code> directory.  The <code>java.naming.factory.initial</code> line tells JNDI to use Guice, the <code>org.guiceyfruit.modules</code> tells the <a href="http://docs.oracle.com/javase/7/docs/api/javax/naming/InitialContext.html">javax.naming.InitialContext class</a> which module it should run at startup.</p>

<figure class='code'><figcaption><span>jndi.properties</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="c"># Guice JNDI provider</span>
</span><span class='line'><span class="na">java.naming.factory.initial</span> <span class="o">=</span> <span class="s">org.apache.camel.guice.jndi.GuiceInitialContextFactory</span>
</span><span class='line'>
</span><span class='line'><span class="c"># list of guice modules to boot up (space separated)</span>
</span><span class='line'><span class="na">org.guiceyfruit.modules</span> <span class="o">=</span> <span class="s">com.timmattison.CamelGuiceApplicationModule</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 2: Create a class with a static main method that will run your Camel routes.  Because JNDI and Guice do most of the work there isn&rsquo;t much to do here.</p>

<figure class='code'><figcaption><span>com.timmattison.CamelApplication</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.naming.InitialContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelApplication</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Create the Camel context with Guice</span>
</span><span class='line'>        <span class="n">InitialContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Loop forever</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Sleep so we don&#39;t kill the CPU</span>
</span><span class='line'>            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 3: Create a class that extends <code>RouteBuilder</code> that implements a route (or multiple routes).</p>

<p>In my case I created a RestRoutes class that used the <a href="http://restlet.com/">RESTlet framework</a> and created a single route using the <a href="https://camel.apache.org/direct.html">Direct component</a>.</p>

<p>I moved the constants out to separate classes so they&rsquo;d be easier to refer to in other places if necessary.</p>

<figure class='code'><figcaption><span>com.timmattison.CamelConstants</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelConstants</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DIRECT_TEST_ROUTE_1</span> <span class="o">=</span> <span class="s">&quot;direct:testRoute1&quot;</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.HttpConstants</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpConstants</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEST_URL_1</span> <span class="o">=</span> <span class="s">&quot;/test1&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEST_URL_2</span> <span class="o">=</span> <span class="s">&quot;/test2&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEST_URL_3</span> <span class="o">=</span> <span class="s">&quot;/test3&quot;</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.RestRoutes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.builder.RouteBuilder</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.model.rest.RestBindingMode</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RestRoutes</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">RESTLET</span> <span class="o">=</span> <span class="s">&quot;restlet&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">restConfiguration</span><span class="o">().</span><span class="na">bindingMode</span><span class="o">(</span><span class="n">RestBindingMode</span><span class="o">.</span><span class="na">auto</span><span class="o">).</span><span class="na">component</span><span class="o">(</span><span class="n">RESTLET</span><span class="o">).</span><span class="na">port</span><span class="o">(</span><span class="n">PORT</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">rest</span><span class="o">(</span><span class="n">HttpConstants</span><span class="o">.</span><span class="na">TEST_URL_1</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">to</span><span class="o">(</span><span class="n">CamelConstants</span><span class="o">.</span><span class="na">DIRECT_TEST_ROUTE_1</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 4: Create the interfaces and the implementations that we&rsquo;re going to use in our route.</p>

<p>Here we&rsquo;re creating four things:</p>

<ol>
<li>The interface that we&rsquo;re implementing that handles the route (<code>SayHello1</code>) that gets injected with Guice via JNDI.  This interface doesn&rsquo;t do anything other than give Guice a way to reference implementations of it.</li>
<li>An implementation of that interface (<code>BasicSayHello1</code>).  Also, <code>BasicSayHello1</code> is going to have a dependency that we want injected with Guice to make the example more complete.</li>
<li>The interface for the class that we want Guice to inject (<code>MessageHandler</code>)</li>
<li>The implementation that gets injected (<code>BasicMessageHandler</code>)</li>
</ol>


<figure class='code'><figcaption><span>com.timmattison.jndibeans.interfaces.SayHello1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">jndibeans</span><span class="o">.</span><span class="na">interfaces</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.Processor</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SayHello1</span> <span class="kd">extends</span> <span class="n">Processor</span> <span class="o">{</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.jndibeans.BasicSayHello1</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">jndibeans</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.interfaces.MessageHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.Exchange</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicSayHello1</span> <span class="kd">implements</span> <span class="n">SayHello1</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MessageHandler</span> <span class="n">messageHandler</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Inject</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">BasicSayHello1</span><span class="o">(</span><span class="n">MessageHandler</span> <span class="n">messageHandler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">messageHandler</span> <span class="o">=</span> <span class="n">messageHandler</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Exchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">exchange</span><span class="o">.</span><span class="na">getOut</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="n">messageHandler</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.nonjndibeans.interfaces.MessageHandler</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">nonjndibeans</span><span class="o">.</span><span class="na">interfaces</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/28/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MessageHandler</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>com.timmattison.nonjndibeans.BasicMessageHandler</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">.</span><span class="na">nonjndibeans</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.interfaces.MessageHandler</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/28/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicMessageHandler</span> <span class="kd">implements</span> <span class="n">MessageHandler</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">input</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 5: Create the direct route that handles the route from <code>RestRoutes</code></p>

<figure class='code'><figcaption><span>com.timmattison.DirectTestRoutes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello2</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello3</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.builder.RouteBuilder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectTestRoutes</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">from</span><span class="o">(</span><span class="n">CamelConstants</span><span class="o">.</span><span class="na">DIRECT_TEST_ROUTE_1</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">beanRef</span><span class="o">(</span><span class="n">SayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Step 6: Create a Guice module that extends <code>CamelModuleWithMatchingRoutes</code>.  I bound my SayHello1 interface to BasicSayHello1, MessageHandler to BasicMessageHandler, and included my RestRoutes and DirectTestRoutes.</p>

<figure class='code'><figcaption><span>com.timmattison.CamelGuiceApplicationModule</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">timmattison</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.BasicSayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.jndibeans.interfaces.SayHello1</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.BasicMessageHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.timmattison.nonjndibeans.interfaces.MessageHandler</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.camel.guice.CamelModuleWithMatchingRoutes</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Created by timmattison on 10/27/14.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelGuiceApplicationModule</span> <span class="kd">extends</span> <span class="n">CamelModuleWithMatchingRoutes</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">configure</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">SayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">BasicSayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">MessageHandler</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">BasicMessageHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">RestRoutes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>        <span class="n">bind</span><span class="o">(</span><span class="n">DirectTestRoutes</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if you don&rsquo;t want Guice to handle any external JNDI bindings then you&rsquo;re done.  You can run this application as-is and it will serve up the RESTlet route.</p>

<p>To run the application from Maven do this:</p>

<figure class='code'><figcaption><span>com.timmattison.CamelGuiceApplicationModule</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">mvn</span> <span class="nl">camel:</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can test it by using cURL like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> curl http://localhost:8000/test1
</span><span class='line'><span class="go">Hello com.timmattison.jndibeans.BasicSayHello1!</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to have Guice handle JNDI bindings you can easily add those into your module.  For example, if I wanted to be able to get an instance of <code>SayHello1</code> by using the JNDI name <code>sayHello1FromGuice</code> I could add this to my module:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="nd">@Provides</span>
</span><span class='line'>    <span class="nd">@JndiBind</span><span class="o">(</span><span class="s">&quot;sayHello1FromGuice&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">SayHello1</span> <span class="nf">sayHello1FromGuice</span><span class="o">(</span><span class="n">Injector</span> <span class="n">injector</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">SayHello1</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This tells JNDI that our Guice provider will handle any JNDI requests for this name.  Luckily, we didn&rsquo;t have to create any of these manually because Guice automatically creates JNDI bindings for anything that you&rsquo;ve called <code>bind</code> on using its class name.</p>

<p>For example there is an automatic JNDI binding for <code>com.timmattison.jndibeans.interfaces.SayHello1</code> because we called <code>bind(SayHello1.class).to(BasicSayHello1.class)</code>.  If we ever want an instance of whatever Guice has bound to this we can ask JNDI for it using <code>SayHello1.class.getName()</code>.</p>

<p>You&rsquo;ll notice that in our <code>DirectTestRoutes</code> class we routed the direct test route to <code>beanRef</code> with the parameter <code>SayHello1.class.getName()</code>.  That&rsquo;s all you need to do as you add more classes to your Camel routes.</p>

<p>Want to try this out without building everything from scratch?  Head over to <a href="http://github.com/timmattison/apache-camel-guice">my apache-camel-guice repo on Github</a>.</p>

<p>Good luck!  Don&rsquo;t forget to post in the comments!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/2014/09/17/hacking-together-a-super-simple-webserver-with-netcat-on-a-raspberry-pi/">Hacking Together a Super Simple Webserver With Netcat on a Raspberry Pi</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-17T08:08:38-04:00" pubdate data-updated="true">Sep 17<span>th</span>, 2014</time>
        
           | <a href="/archives/2014/09/17/hacking-together-a-super-simple-webserver-with-netcat-on-a-raspberry-pi/#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com/archives/2014/09/17/hacking-together-a-super-simple-webserver-with-netcat-on-a-raspberry-pi/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few months ago I wanted to get some data out of <a href="http://www.itwatchdogs.com/climate-monitor-weathergoose-ii-p1.html">WeatherGoose II Climate Monitor</a> so I could convert it into JSON and consume it in another application.  I hacked something together and converted their format to JSON in a few hours as a proof-of-concept and the code sat for a few months.</p>

<p>A co-worker recently asked me if they could hook up to my script with a browser to try to do some visualization.  I didn&rsquo;t want to install Apache or nginx as a front end and I didn&rsquo;t want to modify the script to run its own webserver so I came up with a one-liner that uses netcat to get the output of my script into their browser.</p>

<p>But wait!  netcat has an option for this.  However, on the Raspberry Pi it is not available and I didn&rsquo;t want to start downloading new versions.</p>

<p>Here it is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">SCRIPT=&quot;./weathergoose.py 192.168.1.99&quot; &amp;&amp; PORT=&quot;8080&quot; &amp;&amp; while true; do $SCRIPT | nc -l -p $PORT; done</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll need to set <code>SCRIPT</code> to the script you want to run (including any parameters it needs) and <code>PORT</code> to the port you want to listen on.</p>

<p>Be careful!  This is not a real webserver.  This just spits your scripts output back to the browser.  Anything the browser sends to the script is ignored.</p>

<p>Also, the script runs first and pipes its output to netcat.  This happens before netcat accepts a connection and can cause some confusion.  Here&rsquo;s a concrete example.</p>

<p>Assume I wrote a script that just returns the time.  If I use the above snippet and start it at 5:00 PM but I hit it with my web browser at 5:15 PM the time that I get back will be 5:00 PM.  The next time I hit it it will be 5:15 PM.  The easiest way to think about it is that you get the data from when the script started or at the time of the <em>previous</em> request, whichever is later.</p>

<p>I hope to come up with a fix for this issue but I haven&rsquo;t had the time yet.  Do you have a fix?  Does this work for you?  Post in the comments below.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/2/">&larr; Older</a>
    
    <a href="/archives">Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Sidebar -->
<ins class="adsbygoogle"
     style="display:inline-block;width:120px;height:240px"
     data-ad-client="ca-pub-9307090849713032"
     data-ad-slot="1616086903"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/2015/07/27/deploying-multiple-war-files-on-a-single-instance-with-elastic-beanstalks-command-line-tools/">Deploying Multiple WAR Files on a Single Instance With Elastic Beanstalk&#8217;s Command-line Tools</a>
      </li>
    
      <li class="post">
        <a href="/archives/2015/07/24/how-would-you-implement-cron-on-aws-as-inexpensively-as-possible/">How Would You Implement &#8220;Cron&#8221; on AWS as Inexpensively as Possible?</a>
      </li>
    
      <li class="post">
        <a href="/archives/2015/03/10/validating-guava-event-bus-interactions-with-mockito/">Validating Guava Event Bus Interactions With Mockito</a>
      </li>
    
      <li class="post">
        <a href="/archives/2014/12/16/mockito-and-servletinputstreams/">Mockito and ServletInputStreams</a>
      </li>
    
      <li class="post">
        <a href="/archives/2014/11/12/fixing-javac-on-mac-os-when-multiple-jvms-are-installed/">Fixing Javac on Mac OS When Multiple JVMs Are Installed</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/timmattison">@timmattison</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'timmattison',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/timmattison?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Tim Mattison -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'timmattison';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
