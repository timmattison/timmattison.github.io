
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How-To: Add Support for SHA1 and SHA512 Functions in PostgreSQL - Tim Mattison</title>
  <meta name="author" content="Tim Mattison">

  
  <meta name="description" content="I was working on comparing some data in PostgreSQL today and I realized just how long it can take to compare millions of rows of bytea data in raw &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.timmattison.com/archives/2009/10/26/how-to-add-support-for-sha1-and-sha512-functions-in-postgresql">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tim Mattison" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46746763-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Tim Mattison</a></h1>
  
    <h2>Every day I hack a bit...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.timmattison.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How-To: Add Support for SHA1 and SHA512 Functions in PostgreSQL</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-10-26T18:51:03-04:00" pubdate data-updated="true">Oct 26<span>th</span>, 2009</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://blog.timmattison.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I was working on comparing some data in PostgreSQL today and I realized just how long it can take to compare millions of rows of bytea data in raw form. The bytea fields ranged from 30 bytes to several kilobytes so I figured that maybe pre-computing the hash and then comparing the hashes would be faster. PostgreSQL only has support for MD5 hashing and <a href="http://www.mathstat.dal.ca/~selinger/md5collision/">we all know how reliable that can be</a>. So, I fired up Google and set out to figure out the best way to do it.  It turns out that if you install pgcrypto.so via the contrib directory you can get SHA1 support and use it directly with the DIGEST function like this:</p>

<pre><code>CREATE OR REPLACE FUNCTION secure_hash(bytea) RETURNS character varying (128) AS $$
BEGIN
  RETURN ENCODE(DIGEST($1, 'sha1'), 'hex');
END;
</code></pre>

<p>There are some good reasons to do it this way but sometimes you want options.  If you&rsquo;re in an environment where installing pgcrypto.so it out of the question you may have some luck trying to do it using PL/Perl.  The caveat here is that <a href="http://www.postgresql.org/docs/8.4/interactive/plperl-trusted.html">PL/Perl must run in trusted mode</a> for this to work and you must have the Digest::SHA package for Perl installed.  If you can meet those criteria here&rsquo;s how you get it running.</p>

<p>Step 1: Add <em>trusted</em> PL/Perl support to your database</p>

<pre><code>createlang plperlu database_name
</code></pre>

<p>Step 2: Create the PL/Perl function that returns the SHA1/SHA512 hash (replace &ldquo;sha512_base64&rdquo; with &ldquo;sha1_base64&rdquo; if you want SHA1 instead)</p>

<pre><code>CREATE FUNCTION secure_digest(bytea) RETURNS character varying(128) AS $$
  use Digest::SHA qw(sha512_base64);
  my $digest = sha512_base64($_[0]);
  return $digest;
$$ LANGUAGE plperlu;
</code></pre>

<p>Step 3: Test the function</p>

<pre><code>database_name=# select secure_digest('timmattison.com');
                                     secure_digest
----------------------------------------------------------------------------------------
 D5/O3RbUhj+1xWfIoikashEo92zCHwna69ffz+koxoQdUTxe2FP5rPmMKeUBU7FbmhQ0+WMKJbCeayhCwANGhA
(1 row)
</code></pre>

<p>That&rsquo;s it, you&rsquo;re ready to start hashing/digesting away.  Is this the most efficient way to do a hash?  No.  The first method is best.  Will it work in a pinch?  Yes.  Some DBAs will not let you install random shared objects on their machine but will install functions like this for you.  Hopefully you either don&rsquo;t have to deal with a DBA or your DBA is nice enough to do one of these solutions.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      








  


<time datetime="2009-10-26T18:51:03-04:00" pubdate data-updated="true">Oct 26<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/categories/how-to/'>How-To</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.timmattison.com/archives/2009/10/26/how-to-add-support-for-sha1-and-sha512-functions-in-postgresql/" data-via="" data-counturl="http://blog.timmattison.com/archives/2009/10/26/how-to-add-support-for-sha1-and-sha512-functions-in-postgresql/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/archives/2009/10/24/how-to-fix-the-dreaded-setup-was-unable-to-create-a-new-system-partition-error-in-windows-7-advanced/" title="Previous Post: How-To: Fix the dreaded "Setup was unable to create a new system partition" error in Windows 7 (advanced)">&laquo; How-To: Fix the dreaded "Setup was unable to create a new system partition" error in Windows 7 (advanced)</a>
      
      
        <a class="basic-alignment right" href="/archives/2009/10/28/how-to-fix-the-cannot-find-luuid-error-on-gentoo/" title="Next Post: How-To: Fix the "cannot find -luuid" error on Gentoo">How-To: Fix the "cannot find -luuid" error on Gentoo &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/2012/05/25/coming-soon-how-to-easily-enable-poe-power-over-ethernet-in-your-homebrew-projects/">Coming Soon: How to Easily Enable PoE (Power Over Ethernet) in Your Homebrew Projects</a>
      </li>
    
      <li class="post">
        <a href="/archives/2012/05/04/how-to-fix-vmware-kernel-module-compile-issues-with-vmware-workstation-8-0-3-and-linux-kernel-3-2-0/">How-To: Fix VMware Kernel Module Compile Issues With VMware Workstation 8.0.3 and Linux Kernel 3.2.0</a>
      </li>
    
      <li class="post">
        <a href="/archives/2012/04/19/tips-for-debugging-springs-transactional-annotation/">Tips for Debugging Spring's @Transactional Annotation</a>
      </li>
    
      <li class="post">
        <a href="/archives/2012/04/17/how-to-get-verizons-media-manager-to-read-content-from-a-network-location/">How-To: Get Verizon's Media Manager to Read Content From a Network Location</a>
      </li>
    
      <li class="post">
        <a href="/archives/2012/04/12/tip-fix-xterm-unknown-terminal-type-messages-in-debian/">Tip: Fix "'Xterm': Unknown Terminal Type" Messages in Debian</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Tim Mattison -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'timmattison';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.timmattison.com/archives/2009/10/26/how-to-add-support-for-sha1-and-sha512-functions-in-postgresql/';
        var disqus_url = 'http://blog.timmattison.com/archives/2009/10/26/how-to-add-support-for-sha1-and-sha512-functions-in-postgresql/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
